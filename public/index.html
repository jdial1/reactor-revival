<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta name="google-site-verification" content="LnIs3f51u0D2EqYjCdWgyctu2zs9jaD8lOEdgZVOcQY" />
    <meta name="ahrefs-site-verification" content="6f807c2421f5870b0cc78388376fd62176627af775873af861cba451423572f2">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Reactor Revival</title>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#11191f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Reactor Revival" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <link rel="icon" type="image/png" href="img/parts/cells/cell_1_1.png" />
    <link rel="apple-touch-icon" href="img/parts/cells/cell_1_1-192x192-maskable.png" />
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.1.1/css/pico.min.css"
    />
    <link rel="stylesheet" href="css/main.css" />
    <script src="lib/pako.min.js"></script>
    <script src="lib/zip.min.js"></script>
    <script src="lib/break_infinity.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>
  <body>
    <div id="splash-container"></div>
    <div id="wrapper" class="hidden"></div>
    <!-- Templates are now loaded via src/services/templateLoader.js -->
    <script type="module" src="src/components/domMapper.js"></script>
    <script type="module" src="src/services/templateLoader.js"></script>
    <script type="module" src="src/utils/logger.js"></script>
    <script type="module" src="src/utils/logging-controls.js"></script>
    <script type="module" src="src/app.js"></script>
    

    <script>
      // Service Worker Registration for PWA
      // This registration is detectable by PWA analyzers like PWABuilder
      (function() {
        // DEVELOPMENT CHECK: Disable Service Worker on localhost to ensure code freshness
        // This prevents the browser from serving cached, stale versions of the game during development
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        if (isLocalhost) {
          console.log('[SW] Localhost detected. Skipping Service Worker registration.');

          // Redirect from GitHub Pages path to local dev path to fix asset 404s/MIME errors
          // This handles cases where the browser is stuck on /reactor-revival/ from previous SW cache
          if (window.location.pathname.indexOf('/reactor-revival/') === 0) {
            console.log('[SW] Redirecting from production path to local /public/ path...');
            const newPath = window.location.pathname.replace('/reactor-revival/', '/public/');
            window.location.replace(newPath + window.location.search + window.location.hash);
            return;
          }

          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister();
                console.log('[SW] Unregistered existing service worker on localhost');
              }
            });
          }
          return;
        }

        if ('serviceWorker' in navigator) {
          const pathParts = window.location.pathname.split('/').filter(p => p);
          const repoName = pathParts.length > 0 ? pathParts[0] : '';
          const basePath = repoName ? `/${repoName}` : '';
          const swPath = `${basePath}/sw.js`;
          const scope = `${basePath}/`;

          function registerServiceWorker() {
            navigator.serviceWorker.register(swPath, { scope: scope })
              .then(function(registration) {
                console.log('[SW] Service Worker registered successfully:', registration.scope);
                if (!navigator.serviceWorker.controller) {
                  navigator.serviceWorker.addEventListener('controllerchange', function() { window.location.reload(); }, { once: true });
                }
                registration.addEventListener('updatefound', function() {
                  const newWorker = registration.installing;
                  if (newWorker) {
                    newWorker.addEventListener('statechange', function() {
                      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        console.log('[SW] New service worker available');
                      }
                    });
                  }
                });

                if (registration.waiting) {
                  console.log('[SW] Service worker waiting to activate');
                }
                if (registration.active) {
                  console.log('[SW] Service worker active');
                }
              })
              .catch(function(error) {
                console.error('[SW] Service Worker registration failed:', error);
              });
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', registerServiceWorker);
          } else {
            registerServiceWorker();
          }
          window.addEventListener('load', registerServiceWorker);
        }
      })();
    </script>
  </body>
</html>
