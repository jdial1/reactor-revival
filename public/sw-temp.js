importScripts("https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-sw.js");self.addEventListener("install",e=>{e.waitUntil(self.skipWaiting())});self.addEventListener("activate",e=>{e.waitUntil(self.clients.claim())});self.addEventListener("message",e=>{e&&e.data&&e.data.type==="SKIP_WAITING"?self.skipWaiting():e&&e.data&&e.data.type==="TRIGGER_VERSION_CHECK"&&a()});workbox.core.clientsClaim();workbox.precaching.precacheAndRoute(self.__WB_MANIFEST);workbox.routing.registerRoute(({request:e})=>e.mode==="navigate",new workbox.strategies.NetworkFirst({cacheName:"pages",plugins:[new workbox.cacheableResponse.CacheableResponsePlugin({statuses:[0,200]})]}));workbox.routing.registerRoute(({request:e})=>e.destination==="image",new workbox.strategies.CacheFirst({cacheName:"images",plugins:[new workbox.expiration.ExpirationPlugin({maxEntries:200,maxAgeSeconds:30*24*60*60}),new workbox.cacheableResponse.CacheableResponsePlugin({statuses:[0,200]})]}));workbox.routing.registerRoute(({request:e})=>e.destination==="script"||e.destination==="style",new workbox.strategies.StaleWhileRevalidate({cacheName:"static-resources"}));workbox.routing.setCatchHandler(({event:e})=>e.request.destination==="document"?caches.match("/index.html"):Response.error());let i;function s(){if(self.location.hostname.includes("github.io")){const t=self.location.pathname.split("/"),o=t.length>1&&t[1]?t[1]:"";return o?`/${o}`:""}return""}function c(){i&&clearInterval(i),i=setInterval(async()=>{await a()},2*60*1e3)}async function a(){try{const e=await f();if(!e){console.log("No local version found, skipping check");return}const t=await d();if(!t){console.log("Could not fetch deployed version");return}console.log(`Version check: Local=${e}, Deployed=${t}`),t!==e&&(console.log(`New version detected: ${t} (current: ${e})`),g(t,e),l(t))}catch(e){console.log("Version check failed:",e)}}function l(e){if(self.Notification&&self.Notification.permission==="granted"){const t="Reactor Revival Update",o={body:`Version ${e} is available! Click to reload.`,icon:"img/parts/cells/cell_1_1.png",badge:"img/parts/cells/cell_1_1-192x192-maskable.png",tag:"reactor-update",renotify:!0,data:{url:self.location.origin+s()}};self.registration.showNotification(t,o)}}self.addEventListener("notificationclick",e=>{e.notification.close(),e.waitUntil(self.clients.matchAll({type:"window",includeUncontrolled:!0}).then(t=>{if(t.length>0){let o=t[0];for(let n=0;n<t.length;n++)t[n].focused&&(o=t[n]);return o.focus()}return self.clients.openWindow(e.notification.data.url||"/")}))});async function d(){try{const e=s(),t=`${self.location.origin}${e}/version.json`,o=await fetch(t,{cache:"no-cache"});if(o.ok)return(await o.json()).version}catch(e){console.log("Failed to get deployed version:",e)}return null}async function f(){try{const e=await caches.open("static-resources"),o=`${s()}/version.json`,n=await e.match(o);if(n)return(await n.json()).version}catch(e){console.log("Failed to get current version:",e)}return null}function g(e,t){self.clients.matchAll().then(o=>{o.forEach(n=>{n.postMessage({type:"NEW_VERSION_AVAILABLE",version:e,currentVersion:t})})})}self.addEventListener("activate",e=>{e.waitUntil(Promise.all([self.clients.claim(),c()]))});async function r(){try{await a()}catch(e){console.log("Periodic sync failed:",e)}}self.addEventListener("periodicsync",e=>{e.tag==="reactor-periodic-sync"&&e.waitUntil(r())});self.addEventListener("sync",e=>{e.tag==="reactor-sync"&&e.waitUntil(r())});
